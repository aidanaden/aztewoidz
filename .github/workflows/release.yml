name: Release
on:
  push:
    tags:
      - "**"
  workflow_dispatch: # Allows manual triggering
jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write # required to create releases
    steps:
      - name: Clone repository
        uses: actions/checkout@v3
      - name: Install Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.14.1
      - uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libwayland-dev libx11-dev xorg-dev libegl-dev libxkbcommon-dev hfsprogs hfsplus hfsutils python3
          version: 1.0
      # - name: Upgrade
      #   run: |
      #     sudo apt update -y
      #     sudo apt upgrade -y
      #     sudo apt dist-upgrade
      - name: Build executables
        run: |
          zig build -Dtarget=x86_64-windows -Doptimize=ReleaseSmall -Dexe_name=aztewoidz-${{github.ref_name}}-windows-x86 &&
          zig build -Dtarget=x86_64-macos -Doptimize=ReleaseSmall -Dexe_name=aztewoidz-${{github.ref_name}}-darwin-x86 &&
          zig build -Dtarget=aarch64-macos -Doptimize=ReleaseSmall -Dexe_name=aztewoidz-${{github.ref_name}}-darwin-aarch64 &&
          zig build -Dtarget=x86_64-linux -Doptimize=ReleaseSmall  -Dexe_name=aztewoidz-${{github.ref_name}}-linux-x86
      - name: Create TAR files
        run: |
          cd ./zig-out/bin
          tar -czvf aztewoidz-${{github.ref_name}}-darwin-amd64.tar.gz aztewoidz-${{github.ref_name}}-darwin-x86
          tar -czvf aztewoidz-${{github.ref_name}}-darwin-arm64.tar.gz aztewoidz-${{github.ref_name}}-darwin-aarch64
          tar -czvf aztewoidz-${{github.ref_name}}-linux-amd64.tar.gz aztewoidz-${{github.ref_name}}-linux-x86
      - name: Generate Checksums
        run: |
          cd ./zig-out/bin
          ls -al
          sha256sum aztewoidz-* > checksums.txt
      # - name: Generate DMG
      #   run: |
      #     dd if=/dev/zero of=/tmp/aztewoidz.dmg bs=1M count=16 status=progress
      #     mkfs.hfsplus -v "Aztewoidz Installer" /tmp/aztewoidz.dmg
      # - name: Mount DMG
      #   run: |
      #     ls -la /etc/modprobe.d
      #     sudo mkdir -pv /mnt/tmp
      #     sudo mount -o loop /tmp/aztewoidz.dmg /mnt/tmp
      #     sudo cp -av ./zig-out/bin/aztewoidz_mac_arm /mnt/tmp
      #     sudo umount /mnt/tmp
      - name: Release
        # uses: softprops/action-gh-release@v2
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ./zig-out/bin/aztewoidz-${{github.ref_name}}-windows-x86.exe
            ./zig-out/bin/aztewoidz-${{github.ref_name}}-darwin-x86
            ./zig-out/bin/aztewoidz-${{github.ref_name}}-darwin-aarch64
            ./zig-out/bin/aztewoidz-${{github.ref_name}}-linux-x86
            ./zig-out/bin/aztewoidz-${{github.ref_name}}-darwin-amd64.tar.gz
            ./zig-out/bin/aztewoidz-${{github.ref_name}}-darwin-arm64.tar.gz
            ./zig-out/bin/aztewoidz-${{github.ref_name}}-linux-amd64.tar.gz
            ./zig-out/bin/checksums.txt
            LICENSE
      - name: Update Homebrew formula
        uses: dawidd6/action-homebrew-bump-formula@v4
        with:
          # Required, custom GitHub access token with the 'public_repo' and 'workflow' scopes
          token: ${{secrets.HOMEBREW_ACCESS_TOKEN}}
          # Optional, will commit with this user name
          # user_name: name
          # Optional, will commit with this user email
          # user_email: email@example.com
          # Optional, will create tap repo fork in organization
          org: aidanaden
          # Optional, use the origin repository instead of forking
          no_fork: false
          # Optional, defaults to homebrew/core
          tap: aidanaden/homebrew-games
          # Formula name, required
          formula: aztewoidz
          # Optional, will be determined automatically
          tag: ${{github.ref}}
          # Optional, will be determined automatically
          revision: ${{github.sha}}
          # Optional, if don't want to check for already open PRs
          force: true # true
    # - name: Update Homebrew Formula
    #   uses: izumin5210/action-homebrew-tap@releases/v0
    #   with:
    #     tap: izumin5210/homebrew-tools
    #     token: ${{ secrets.HOMEBREW_ACCESS_TOKEN }}
    #     tap-token: ${{ secrets.HOMEBREW_ACCESS_TOKEN }}
    #   if: startsWith(github.ref, 'refs/tags/')
